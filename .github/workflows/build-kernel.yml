# Build kernel with Docker support for Ubuntu Touch
name: Build Miatoll Kernel with Docker Support

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  DEVICE_REPO: https://gitlab.com/ubports/porting/community-ports/android10/xiaomi-redmi-note-9-pro/xiaomi-miatoll.git
  DEVICE_BRANCH: halium-10.0
  KERNEL_REPO: https://gitlab.com/ubports/community-ports/android10/xiaomi-redmi-note-9-pro/kernel-xiaomi-sm6250.git
  KERNEL_BRANCH: halium-10.0-release

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4

    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
        sudo apt-get clean
        df -h

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ca-certificates cpio curl flex git \
          kmod libssl-dev libtinfo5 python2 python3 unzip wget xz-utils \
          android-tools-mkbootimg img2simg jq device-tree-compiler \
          gcc-aarch64-linux-gnu crossbuild-essential-arm64 libelf-dev

    - name: Clone device repository
      run: |
        git clone --depth 1 -b $DEVICE_BRANCH $DEVICE_REPO device
        ls -la device/

    - name: Pre-clone kernel and add halium.config
      run: |
        # Create the exact directory structure the build script expects
        mkdir -p workdir/downloads
        echo "Cloning kernel repository to correct location..."
        git clone --depth 1 -b $KERNEL_BRANCH $KERNEL_REPO workdir/downloads/kernel-xiaomi-sm6250
        echo "Creating halium.config with Docker support..."
        echo "CONFIG_POSIX_MQUEUE=y" > workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_POSIX_MQUEUE_SYSCTL=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NF_TABLES=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NF_TABLES_INET=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NF_TABLES_NETDEV=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_NUMGEN=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_CT=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_COUNTER=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_LOG=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_LIMIT=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_MASQ=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_REDIR=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_NAT=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_REJECT=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_COMPAT=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NFT_HASH=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NETFILTER_XT_MATCH_CGROUP=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NETFILTER_XT_MATCH_IPVS=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_VETH=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_BRIDGE=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_BRIDGE_NETFILTER=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_IP_NF_NAT=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_IP_NF_TARGET_MASQUERADE=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_IP_NF_TARGET_REDIRECT=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_OVERLAY_FS=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_CGROUP_PIDS=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_CPUSETS=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_MEMCG=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "CONFIG_USER_NS=y" >> workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        echo "=== halium.config created ==="
        cat workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/halium.config
        ls -la workdir/downloads/kernel-xiaomi-sm6250/arch/arm64/configs/

    - name: Update deviceinfo to include halium.config
      run: |
        sed -i 's/deviceinfo_kernel_defconfig="cust_defconfig"/deviceinfo_kernel_defconfig="cust_defconfig halium.config"/' device/deviceinfo
        echo "=== Updated deviceinfo ==="
        grep "defconfig" device/deviceinfo

    - name: Build kernel
      run: |
        cd device
        chmod +x build.sh build/*.sh 2>/dev/null || true
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        ./build.sh -b ../workdir 2>&1 | tee ../build.log
      timeout-minutes: 90

    - name: Collect build artifacts
      if: always()
      run: |
        mkdir -p artifacts
        find workdir -name "boot.img" -exec cp {} artifacts/ \; 2>/dev/null || true
        find workdir -name "recovery.img" -exec cp {} artifacts/ \; 2>/dev/null || true
        find device -name "boot.img" -exec cp {} artifacts/ \; 2>/dev/null || true
        find device/out -name "*.img" -exec cp {} artifacts/ \; 2>/dev/null || true
        cp build.log artifacts/ 2>/dev/null || true
        echo "=== Artifacts collected ==="
        ls -la artifacts/

    - name: Upload kernel artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: miatoll-docker-kernel-${{ github.run_number }}
        path: artifacts/
        retention-days: 30
        if-no-files-found: warn
